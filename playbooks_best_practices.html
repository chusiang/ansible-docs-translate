

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>最佳實踐 &mdash; ansible中文權威指南 1.0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ansible中文權威指南 1.0.1 documentation" href="index.html"/>
        <link rel="up" title="Playbooks" href="playbooks.html"/>
        <link rel="next" title="Playbooks: Special Topics" href="playbooks_special_topics.html"/>
        <link rel="prev" title="迴圈" href="playbooks_loops.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> ansible中文權威指南
          

          
          </a>

          
            
            
              <div class="version">
                1.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">總體介紹</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">快速學習視訊</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="playbooks.html">Playbooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="playbooks_intro.html">Playbooks 介紹</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks_roles.html">Playbook Roles and Include Statements</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks_variables.html">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks_conditionals.html">條件選擇</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks_loops.html">迴圈</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">最佳實踐</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#content-organization">Content Organization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#directory-layout">Directory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-dynamic-inventory-with-clouds">Use Dynamic Inventory With Clouds</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-differentiate-stage-vs-production">How to Differentiate  Stage vs Production</a></li>
<li class="toctree-l4"><a class="reference internal" href="#group-and-host-variables">Group And Host Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#top-level-playbooks-are-separated-by-role">Top Level Playbooks Are Separated By Role</a></li>
<li class="toctree-l4"><a class="reference internal" href="#task-and-handler-organization-for-a-role">Task And Handler Organization For A Role</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-this-organization-enables-examples">What This Organization Enables (Examples)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deployment-vs-configuration-organization">Deployment vs Configuration Organization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#stage-vs-production">Stage vs Production</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rolling-updates">Rolling Updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#always-mention-the-state">Always Mention The State</a></li>
<li class="toctree-l3"><a class="reference internal" href="#group-by-roles">Group By Roles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operating-system-and-distribution-variance">Operating System and Distribution Variance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bundling-ansible-modules-with-playbooks">Bundling Ansible Modules With Playbooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#whitespace-and-comments">Whitespace and Comments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#always-name-tasks">Always Name Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keep-it-simple">Keep It Simple</a></li>
<li class="toctree-l3"><a class="reference internal" href="#version-control">Version Control</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="playbooks_special_topics.html">Playbooks: Special Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">模組相關</a></li>
<li class="toctree-l1"><a class="reference internal" href="guides.html">詳細指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">開發者須知</a></li>
<li class="toctree-l1"><a class="reference internal" href="tower.html">Ansible Tower</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html">Ansible使用者</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html#id6">對當前和未來的開發人員</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html#id9">其它主題</a></li>
<li class="toctree-l1"><a class="reference internal" href="galaxy.html">Ansible Galaxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_strategies.html">測試策略</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常見問題</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">術語表</a></li>
<li class="toctree-l1"><a class="reference internal" href="YAMLSyntax.html">YAML 語法</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">ansible中文權威指南</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="playbooks.html">Playbooks</a> &raquo;</li>
      
    <li>最佳實踐</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/playbooks_best_practices.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1><a class="toc-backref" href="#id9">最佳實踐</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>這裡有些給使用和編寫 Ansible playbook 的貼士.</p>
<p>你能在我們的 <a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-example repository</a>.找到展示這些最佳實踐的 playbook 樣例.(注意: 這些示例用的也許不是最新版的中所有特性,但它們仍舊是極佳的參考.)</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id9">最佳實踐</a><ul>
<li><a class="reference internal" href="#content-organization" id="id10">Content Organization</a><ul>
<li><a class="reference internal" href="#directory-layout" id="id11">Directory Layout</a></li>
<li><a class="reference internal" href="#use-dynamic-inventory-with-clouds" id="id12">Use Dynamic Inventory With Clouds</a></li>
<li><a class="reference internal" href="#how-to-differentiate-stage-vs-production" id="id13">How to Differentiate  Stage vs Production</a></li>
<li><a class="reference internal" href="#group-and-host-variables" id="id14">Group And Host Variables</a></li>
<li><a class="reference internal" href="#top-level-playbooks-are-separated-by-role" id="id15">Top Level Playbooks Are Separated By Role</a></li>
<li><a class="reference internal" href="#task-and-handler-organization-for-a-role" id="id16">Task And Handler Organization For A Role</a></li>
<li><a class="reference internal" href="#what-this-organization-enables-examples" id="id17">What This Organization Enables (Examples)</a></li>
<li><a class="reference internal" href="#deployment-vs-configuration-organization" id="id18">Deployment vs Configuration Organization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#stage-vs-production" id="id19">Stage vs Production</a></li>
<li><a class="reference internal" href="#rolling-updates" id="id20">Rolling Updates</a></li>
<li><a class="reference internal" href="#always-mention-the-state" id="id21">Always Mention The State</a></li>
<li><a class="reference internal" href="#group-by-roles" id="id22">Group By Roles</a></li>
<li><a class="reference internal" href="#operating-system-and-distribution-variance" id="id23">Operating System and Distribution Variance</a></li>
<li><a class="reference internal" href="#bundling-ansible-modules-with-playbooks" id="id24">Bundling Ansible Modules With Playbooks</a></li>
<li><a class="reference internal" href="#whitespace-and-comments" id="id25">Whitespace and Comments</a></li>
<li><a class="reference internal" href="#always-name-tasks" id="id26">Always Name Tasks</a></li>
<li><a class="reference internal" href="#keep-it-simple" id="id27">Keep It Simple</a></li>
<li><a class="reference internal" href="#version-control" id="id28">Version Control</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="content-organization">
<span id="id2"></span><h2><a class="toc-backref" href="#id10">Content Organization</a><a class="headerlink" href="#content-organization" title="Permalink to this headline">¶</a></h2>
<p>接下來的章節將向你展示一種組織 playbook 內容方式.</p>
<p>你對 Ansible 的使用應該符合你的需求而不是我們的,所以請隨意根據你的需求來組織修改接下來的示例.</p>
<p>有件事絕對是你想要做的,那就是使用 &#8220;roles&#8221; 組織特性.它作為主要的 playbook 的主要部分被文件化.詳情參見 <a class="reference internal" href="playbooks_roles.html"><em>Playbook Roles and Include Statements</em></a>. 你絕對應該使用 roles.
roles 是極好的. 快去使用 roles！ roles！ 重要的事情要重複說！roles 是極好的.(譯者:..老外也知道重要的事情重複三遍啊！~~~)</p>
<div class="section" id="directory-layout">
<span id="id3"></span><h3><a class="toc-backref" href="#id11">Directory Layout</a><a class="headerlink" href="#directory-layout" title="Permalink to this headline">¶</a></h3>
<p>頂層目錄結構應當包括下列檔案和目錄:</p>
<div class="highlight-python"><div class="highlight"><pre>production                # inventory file for production servers 關於生產環境伺服器的清單檔案
stage                     # inventory file for stage environment 關於 stage 環境的清單檔案

group_vars/
   group1                 # here we assign variables to particular groups 這裡我們給特定的組賦值
   group2                 # &quot;&quot;
host_vars/
   hostname1              # if systems need specific variables, put them here 如果系統需要特定的變數,把它們放置在這裡.
   hostname2              # &quot;&quot;

library/                  # if any custom modules, put them here (optional) 如果有自定義的模組,放在這裡(可選)
filter_plugins/           # if any custom filter plugins, put them here (optional) 如果有自定義的過濾外掛,放在這裡(可選)

site.yml                  # master playbook 主 playbook
webservers.yml            # playbook for webserver tier Web 伺服器的 playbook
dbservers.yml             # playbook for dbserver tier 資料庫伺服器的 playbook

roles/
    common/               # this hierarchy represents a &quot;role&quot; 這裡的結構代表了一個 &quot;role&quot;
        tasks/            #
            main.yml      #  &lt;-- tasks file can include smaller files if warranted
        handlers/         #
            main.yml      #  &lt;-- handlers file
        templates/        #  &lt;-- files for use with the template resource
            ntp.conf.j2   #  &lt;------- templates end in .j2
        files/            #
            bar.txt       #  &lt;-- files for use with the copy resource
            foo.sh        #  &lt;-- script files for use with the script resource
        vars/             #
            main.yml      #  &lt;-- variables associated with this role
        defaults/         #
            main.yml      #  &lt;-- default lower priority variables for this role
        meta/             #
            main.yml      #  &lt;-- role dependencies

    webtier/              # same kind of structure as &quot;common&quot; was above, done for the webtier role
    monitoring/           # &quot;&quot;
    fooapp/               # &quot;&quot;
</pre></div>
</div>
</div>
<div class="section" id="use-dynamic-inventory-with-clouds">
<span id="id4"></span><h3><a class="toc-backref" href="#id12">Use Dynamic Inventory With Clouds</a><a class="headerlink" href="#use-dynamic-inventory-with-clouds" title="Permalink to this headline">¶</a></h3>
<p>如果你正在使用雲服務,你不應該在一個靜態檔案管理你的清單.詳見 <a class="reference internal" href="intro_dynamic_inventory.html"><em>動態 Inventory</em></a>.</p>
<p>這不僅適用於雲環境 &#8211; 如果你的基礎設施中還有其他系統維護著一系列標準系統,使用 動態清單 會是個好主意.</p>
</div>
<div class="section" id="how-to-differentiate-stage-vs-production">
<span id="stage-vs-prod"></span><h3><a class="toc-backref" href="#id13">How to Differentiate  Stage vs Production</a><a class="headerlink" href="#how-to-differentiate-stage-vs-production" title="Permalink to this headline">¶</a></h3>
<p>If managing static inventory, it is frequently asked how to differentiate different types of environments.  The following example
shows a good way to do this.  Similar methods of grouping could be adapted to dynamic inventory (for instance, consider applying the AWS
tag &#8220;environment:production&#8221;, and you&#8217;ll get a group of systems automatically discovered named &#8220;ec2_tag_environment_production&#8221;.</p>
<p>如果你管理著靜態清單,如何區分不同的環境類型是個常見的問題.接下來的示例會做一個很好地說明.</p>
<p>Let&#8217;s show a static inventory example though.  Below, the <em>production</em> file contains the inventory of all of your production hosts.</p>
<p>It is suggested that you define groups based on purpose of the host (roles) and also geography or datacenter location (if applicable):</p>
<div class="highlight-python"><div class="highlight"><pre># file: production

[atlanta-webservers]
www-atl-1.example.com
www-atl-2.example.com

[boston-webservers]
www-bos-1.example.com
www-bos-2.example.com

[atlanta-dbservers]
db-atl-1.example.com
db-atl-2.example.com

[boston-dbservers]
db-bos-1.example.com

# webservers in all geos
[webservers:children]
atlanta-webservers
boston-webservers

# dbservers in all geos
[dbservers:children]
atlanta-dbservers
boston-dbservers

# everything in the atlanta geo
[atlanta:children]
atlanta-webservers
atlanta-dbservers

# everything in the boston geo
[boston:children]
boston-webservers
boston-dbservers
</pre></div>
</div>
</div>
<div class="section" id="group-and-host-variables">
<span id="groups-and-hosts"></span><h3><a class="toc-backref" href="#id14">Group And Host Variables</a><a class="headerlink" href="#group-and-host-variables" title="Permalink to this headline">¶</a></h3>
<p>本章節內容基於前一章節示例.</p>
<p>分組有利於組織結構,但不是所有的分組都是有益的.你也可以給他們賦值!比如說亞特蘭大有它自己的網路時間協議,
所以當配置 ntp.conf 時,我們就該使用它.讓我們現在設定它們:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: group_vars/atlanta
ntp: ntp-atlanta.example.com
backup: backup-atlanta.example.com
</pre></div>
</div>
<p>Variables aren&#8217;t just for geographic information either!  Maybe the webservers have some configuration that doesn&#8217;t make sense for the database servers:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: group_vars/webservers
apacheMaxRequestsPerChild: 3000
apacheMaxClients: 900
</pre></div>
</div>
<p>If we had any default values, or values that were universally true, we would put them in a file called group_vars/all:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: group_vars/all
ntp: ntp-boston.example.com
backup: backup-boston.example.com
</pre></div>
</div>
<p>We can define specific hardware variance in systems in a host_vars file, but avoid doing this unless you need to:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: host_vars/db-bos-1.example.com
foo_agent_port: 86
bar_agent_port: 99
</pre></div>
</div>
<p>Again, if we are using dynamic inventory sources, many dynamic groups are automatically created.  So a tag like &#8220;class:webserver&#8221; would load in
variables from the file &#8220;group_vars/ec2_tag_class_webserver&#8221; automatically.</p>
</div>
<div class="section" id="top-level-playbooks-are-separated-by-role">
<span id="split-by-role"></span><h3><a class="toc-backref" href="#id15">Top Level Playbooks Are Separated By Role</a><a class="headerlink" href="#top-level-playbooks-are-separated-by-role" title="Permalink to this headline">¶</a></h3>
<p>在 site.yml 中,我們包含了一個定義了整個基礎設施的 playbook.注意這個 playbook 是非常短的,
因為它僅僅包含了其他 playbooks.記住, playbook 不過就是一系列的 <cite>plays</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: site.yml
- include: webservers.yml
- include: dbservers.yml
</pre></div>
</div>
<p>在諸如 like webservers.yml 的檔案中(同樣也在頂層結構),我們僅僅將 Web 伺服器組與對應的 role 行為做對映.同樣值得注意的是這也非常的短小精悍.例如:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: webservers.yml
- hosts: webservers
  roles:
    - common
    - webtier
</pre></div>
</div>
<p>理念是我們能夠通過 &#8220;執行&#8221;(running) site.yml 來選擇整個基礎設施的配置.或者我們能夠通過執行其子集 webservers.yml 來配置.
這與 Ansible 的 &#8220;&#8211;limit&#8221; 類似,而且相對的更為顯式:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible-playbook site.yml --limit webservers
ansible-playbook webservers.yml
</pre></div>
</div>
</div>
<div class="section" id="task-and-handler-organization-for-a-role">
<span id="role-organization"></span><h3><a class="toc-backref" href="#id16">Task And Handler Organization For A Role</a><a class="headerlink" href="#task-and-handler-organization-for-a-role" title="Permalink to this headline">¶</a></h3>
<p>接下來的示例任務檔案展示了一個 role 是如何工作的.我們這裡的普通 role 僅僅用來配置 NTP,但是如果我們想的話,它可以做更多:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: roles/common/tasks/main.yml

- name: be sure ntp is installed
  yum: pkg=ntp state=installed
  tags: ntp

- name: be sure ntp is configured
  template: src=ntp.conf.j2 dest=/etc/ntp.conf
  notify:
    - restart ntpd
  tags: ntp

- name: be sure ntpd is running and enabled
  service: name=ntpd state=running enabled=yes
  tags: ntp
</pre></div>
</div>
<p>這是個處理檔案樣例.作為一種稽核,它只有當特定的任務報告發生變化時會被觸發,並在每個 play 結束時執行:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: roles/common/handlers/main.yml
- name: restart ntpd
  service: name=ntpd state=restarted
</pre></div>
</div>
<p>詳情請參閱 <a class="reference internal" href="playbooks_roles.html"><em>Playbook Roles and Include Statements</em></a>.</p>
</div>
<div class="section" id="what-this-organization-enables-examples">
<span id="organization-examples"></span><h3><a class="toc-backref" href="#id17">What This Organization Enables (Examples)</a><a class="headerlink" href="#what-this-organization-enables-examples" title="Permalink to this headline">¶</a></h3>
<p>我們在前文分享了我們基礎的組織結構.</p>
<p>那這種結構適用於何種應用場景？ 很多！若我想重新配置整個基礎設施,如此即可:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible-playbook -i production site.yml
</pre></div>
</div>
<p>那隻重新配置所有的 NTP 呢？太容易了.:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible-playbook -i production site.yml --tags ntp
</pre></div>
</div>
<p>只重新配置我的 Web 伺服器呢？:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible-playbook -i production webservers.yml
</pre></div>
</div>
<p>只重新配置我在波士頓的 Web伺服器呢?:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible-playbook -i production webservers.yml --limit boston
</pre></div>
</div>
<p>前10臺 和 接下來的10臺呢？</p>
<blockquote>
<div>ansible-playbook -i production webservers.yml &#8211;limit boston[0-10]
ansible-playbook -i production webservers.yml &#8211;limit boston[10-20]</div></blockquote>
<p>當然,只使用基礎的 ad-hoc 也是 OK 的啦.:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible boston -i production -m ping
ansible boston -i production -m command -a &#39;/sbin/reboot&#39;
</pre></div>
</div>
<p>這裡還有些有用的命令你需要知道(版本至少 1.1 或更高):</p>
<div class="highlight-python"><div class="highlight"><pre># confirm what task names would be run if I ran this command and said &quot;just ntp tasks&quot;
ansible-playbook -i production webservers.yml --tags ntp --list-tasks

# confirm what hostnames might be communicated with if I said &quot;limit to boston&quot;
ansible-playbook -i production webservers.yml --limit boston --list-hosts
</pre></div>
</div>
</div>
<div class="section" id="deployment-vs-configuration-organization">
<span id="dep-vs-config"></span><h3><a class="toc-backref" href="#id18">Deployment vs Configuration Organization</a><a class="headerlink" href="#deployment-vs-configuration-organization" title="Permalink to this headline">¶</a></h3>
<p>The above setup models a typical configuration topology.  When doing multi-tier deployments, there are going
to be some additional playbooks that hop between tiers to roll out an application.  In this case, &#8216;site.yml&#8217;
may be augmented by playbooks like &#8216;deploy_exampledotcom.yml&#8217; but the general concepts can still apply.</p>
<p>Consider &#8220;playbooks&#8221; as a sports metaphor &#8211; you don&#8217;t have to just have one set of plays to use against your infrastructure
all the time &#8211; you can have situational plays that you use at different times and for different purposes.</p>
<p>Ansible allows you to deploy and configure using the same tool, so you would likely reuse groups and just
keep the OS configuration in separate playbooks from the app deployment.</p>
</div>
</div>
<div class="section" id="stage-vs-production">
<span id="id5"></span><h2><a class="toc-backref" href="#id19">Stage vs Production</a><a class="headerlink" href="#stage-vs-production" title="Permalink to this headline">¶</a></h2>
<p>如前所述,通過使用不同的清單檔案來分離你的 stage 和 生產環境是個好方法.你可以通過 -i 來指定.把它們放在同一個檔案中會有驚喜哦！
在部署到生產環境之前,先在 stage 環境中做測試是個好主意.你的環境不必保持同樣的大小,你可以通過 分組變數來對不同的環境進行控制.</p>
</div>
<div class="section" id="rolling-updates">
<span id="rolling-update"></span><h2><a class="toc-backref" href="#id20">Rolling Updates</a><a class="headerlink" href="#rolling-updates" title="Permalink to this headline">¶</a></h2>
<p>請理解 &#8216;serial&#8217; 關鍵字.你會在批量升級中使用它來控制升級機器的數量.</p>
<p>See <a class="reference internal" href="playbooks_delegation.html"><em>委託,滾動更新,本地動作</em></a>.</p>
</div>
<div class="section" id="always-mention-the-state">
<span id="mention-the-state"></span><h2><a class="toc-backref" href="#id21">Always Mention The State</a><a class="headerlink" href="#always-mention-the-state" title="Permalink to this headline">¶</a></h2>
<p>parameter in your playbooks to make it clear, especially as some modules support additional states.
對於很多模組來說 &#8216;state&#8217; 參數是可選的.無論是 &#8216;state=present&#8217; 亦或 &#8216;state=absent&#8217; ,你最好在 playbook 中顯式指定該參數,畢竟有些模組是支援附加的 &#8216;state&#8217; 參數.</p>
</div>
<div class="section" id="group-by-roles">
<span id="id6"></span><h2><a class="toc-backref" href="#id22">Group By Roles</a><a class="headerlink" href="#group-by-roles" title="Permalink to this headline">¶</a></h2>
<p>在這條貼士中,我們某種程度上在重複自己,但這是值得的.一個系統可能被分成多分組.詳情請查閱 <a class="reference internal" href="intro_inventory.html"><em>Inventory檔案</em></a> 和 <a class="reference internal" href="intro_patterns.html"><em>Patterns</em></a>.
在樣例中,分組名之後的 <em>webservers</em> 和 <em>dbservers</em> ,它們因為是很重要的概念所以反覆出現.(譯者:恩,重要的事情要重複三遍！)一個系統可以出現在多個分組中.</p>
<p>通過給 role 賦予特定的變數,這允許 playbooks 能基於角色來鎖定機器.</p>
<p>See <a class="reference internal" href="playbooks_roles.html"><em>Playbook Roles and Include Statements</em></a>.</p>
</div>
<div class="section" id="operating-system-and-distribution-variance">
<span id="os-variance"></span><h2><a class="toc-backref" href="#id23">Operating System and Distribution Variance</a><a class="headerlink" href="#operating-system-and-distribution-variance" title="Permalink to this headline">¶</a></h2>
<p>當處理在不同作業系統間參數值不同的參數時,使用 group_by 模組是個好主意.</p>
<p>這使宿主機的動態分組有了匹配的標準,即使該分組尚未在清單檔案中被定義</p>
<div class="highlight-python"><div class="highlight"><pre>---

# talk to all hosts just so we can learn about them
- hosts: all
  tasks:
     - group_by: key=os_{{ ansible_distribution }}

# now just on the CentOS hosts...

- hosts: os_CentOS
  gather_facts: False
  tasks:
     - # tasks that only happen on CentOS go here
</pre></div>
</div>
<p>這會拋出所有基於作業系統名的分組.</p>
<p>如果需要對特定分組做設定,這也是可以的.例:</p>
<div class="highlight-python"><div class="highlight"><pre>---
# file: group_vars/all
asdf: 10

---
# file: group_vars/os_CentOS
asdf: 42
</pre></div>
</div>
<p>在上述的例子中, CentOS 的機器獲取的 asdf 的值為 42,但其他機器獲得是 &#8216;10&#8217;.這不止可以用於設定變數,也可以將特定的 role 應用於特定的作業系統.</p>
<p>相對的,如果只需要變數:</p>
<div class="highlight-python"><div class="highlight"><pre>- hosts: all
  tasks:
    - include_vars: &quot;os_{{ ansible_distribution }}.yml&quot;
    - debug: var=asdf
</pre></div>
</div>
<p>這將根據作業系統名來拉取相應的值.</p>
</div>
<div class="section" id="bundling-ansible-modules-with-playbooks">
<span id="ship-modules-with-playbooks"></span><h2><a class="toc-backref" href="#id24">Bundling Ansible Modules With Playbooks</a><a class="headerlink" href="#bundling-ansible-modules-with-playbooks" title="Permalink to this headline">¶</a></h2>
<p>如果一個 playbook 有一個與它 YMAL 檔案相關的 &#8221;./library&#8221; 目錄,該目錄可以用於新增 Ansible 模組,它會被自動新增到 Ansible 模組的路徑中.這是一個將
playbook 與其模組放置在一起的方式.如下面的目錄結構樣例所展示:</p>
<div class="highlight-python"><div class="highlight"><pre>.. _whitespace:
</pre></div>
</div>
</div>
<div class="section" id="whitespace-and-comments">
<h2><a class="toc-backref" href="#id25">Whitespace and Comments</a><a class="headerlink" href="#whitespace-and-comments" title="Permalink to this headline">¶</a></h2>
<p>鼓勵使用空格來分隔內容,用 &#8216;#&#8217; 來寫註釋.</p>
</div>
<div class="section" id="always-name-tasks">
<span id="name-tasks"></span><h2><a class="toc-backref" href="#id26">Always Name Tasks</a><a class="headerlink" href="#always-name-tasks" title="Permalink to this headline">¶</a></h2>
<p>雖然推薦提供關於為什麼要這麼做的描述,但是直接給一個給定任務命名也是可以的.名字會在 playbook 執行時顯示.</p>
</div>
<div class="section" id="keep-it-simple">
<span id="id7"></span><h2><a class="toc-backref" href="#id27">Keep It Simple</a><a class="headerlink" href="#keep-it-simple" title="Permalink to this headline">¶</a></h2>
<p>當你能簡單的搞定某事時,就簡單的搞定.不要試圖一次性使用 Ansible 的所有的特性.僅僅使用對你有用的即可.
比如說你基本上不會需要一次性使用 <code class="docutils literal"><span class="pre">vars</span></code> , <code class="docutils literal"><span class="pre">vars_files</span></code> , <code class="docutils literal"><span class="pre">vars_prompt</span></code> 和 <code class="docutils literal"><span class="pre">--extra-vars</span></code> 同時還是用一個外部的節點配置檔案.</p>
<p>如果你感覺任務很複雜時,它可能真的很複雜,這也許是個簡化它的好機會.</p>
</div>
<div class="section" id="version-control">
<span id="id8"></span><h2><a class="toc-backref" href="#id28">Version Control</a><a class="headerlink" href="#version-control" title="Permalink to this headline">¶</a></h2>
<p>請使用版本控制.保持你的 playbook 和 清單檔案 在 git(或其他版本控制系統)中,並將你的修改做提交.
這樣你就有審計軌跡來描述什麼時候以及為什麼你做了這樣的修改.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="YAMLSyntax.html"><em>YAML 語法</em></a></dt>
<dd>Learn about YAML syntax</dd>
<dt><a class="reference internal" href="playbooks.html"><em>Playbooks</em></a></dt>
<dd>Review the basic playbook features</dd>
<dt><a class="reference internal" href="modules.html"><em>模組相關</em></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="developing_modules.html"><em>Developing Modules</em></a></dt>
<dd>Learn how to extend Ansible by writing your own modules</dd>
<dt><a class="reference internal" href="intro_patterns.html"><em>Patterns</em></a></dt>
<dd>Learn about how to select hosts</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible/tree/devel/examples/playbooks">GitHub examples directory</a></dt>
<dd>Complete playbook files from the github project source</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="playbooks_special_topics.html" class="btn btn-neutral float-right" title="Playbooks: Special Topics" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="playbooks_loops.html" class="btn btn-neutral" title="迴圈" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, www.magedu.com, AUTHORS: 薛定諤的章魚 &amp; guli &amp; 以馬內利 &amp; 黃博文 &amp; coocla &amp; 雲中鶴 &amp; stanley.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>